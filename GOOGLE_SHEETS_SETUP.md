# Google連携セットアップガイド（Sheets + Drive統合）

このガイドでは、全ての承認済み支出データをGoogle Sheetsに同期し、請求書・領収書画像をGoogle Driveで月別整理して、最終的にマネーフォワードと連携するための設定方法を説明します。

## 1. Google Cloud Projectの設定

### 1.1 Google Cloud Consoleでプロジェクトを作成
1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成するか、既存のプロジェクトを選択

### 1.2 必要なAPIを有効化
**Google Sheets API:**
1. APIとサービス > ライブラリ にアクセス
2. "Google Sheets API"を検索して選択
3. "有効にする"をクリック

**Google Drive API:**
1. 同じくライブラリで "Google Drive API" を検索
2. "Google Drive API"を選択
3. "有効にする"をクリック

### 1.3 サービスアカウントの作成
1. APIとサービス > 認証情報 にアクセス
2. "認証情報を作成" > "サービス アカウント"を選択
3. サービスアカウント名を入力（例：`zeroko-cash-sheets`）
4. 必要に応じて説明を追加
5. "作成して続行"をクリック
6. ロールの選択はスキップ（"完了"をクリック）

### 1.4 サービスアカウントキーの生成
1. 作成したサービスアカウントをクリック
2. "キー"タブに移動
3. "鍵を追加" > "新しい鍵を作成"をクリック
4. "JSON"を選択して"作成"をクリック
5. ダウンロードされたJSONファイルを安全な場所に保存

## 2. Google Sheetsの準備

### 2.1 統合スプレッドシートの作成
1. [Google Sheets](https://sheets.google.com/)で新しいスプレッドシートを1つ作成：
   - **全支出データ統合用スプレッドシート**（マネーフォワード連携用）

### 2.2 シート名の設定
統合スプレッドシート：
- シート名：`全支出データ`

このシートには以下の3種類の支出データが統合されて記録されます：
- 承認された経費申請
- 承認された請求書払い申請  
- 完了/支払い待ち状態の外注契約

### 2.3 権限の設定
1. スプレッドシートで「共有」をクリック
2. サービスアカウントのメールアドレス（JSONファイル内の`client_email`）を追加
3. 権限を「編集者」に設定
4. 「送信」をクリック

### 2.4 スプレッドシートIDの取得
スプレッドシートのURLから ID を取得：
```
https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/edit#gid=0
```

このIDを環境変数 `GOOGLE_SHEETS_ALL_EXPENSES_ID` として設定します。

## 3. Google Drive連携の準備

### 3.1 共有ドライブ（Team Drive）の作成
**重要**: サービスアカウントは個人のGoogleドライブにファイルを保存できません。共有ドライブを使用する必要があります。

#### 共有ドライブの作成手順：
1. [Google Drive](https://drive.google.com/)にアクセス
2. 左サイドバーの「共有ドライブ」をクリック
3. 「新規」ボタンをクリック
4. 共有ドライブ名を入力（例：「支出管理システム」）
5. 「作成」をクリック

#### サービスアカウントの追加：
1. 作成した共有ドライブをクリック
2. 右上の「メンバーを管理」をクリック
3. サービスアカウントのメールアドレス（JSONファイル内の`client_email`）を追加
4. 権限を「コンテンツ管理者」に設定
5. 「送信」をクリック

#### 共有ドライブIDの取得：
1. 作成した共有ドライブを開く
2. URLから共有ドライブIDを取得：
   ```
   https://drive.google.com/drive/folders/{SHARED_DRIVE_ID}
   ```
3. このIDを環境変数 `GOOGLE_DRIVE_ROOT_FOLDER_ID` として設定

### 3.2 Driveフォルダの設定
Google Driveでの画像整理は共有ドライブ内で自動で行われます：

1. **自動作成（推奨）**: セットアップスクリプトが共有ドライブ内に自動でフォルダを作成
2. **手動作成**: 共有ドライブ内の任意の場所にフォルダを作成してIDを指定

### 3.2 フォルダ構造
```
支出管理_領収書・請求書/
├── 2024/
│   ├── 01月/
│   │   ├── 経費申請/
│   │   ├── 請求書払い/
│   │   └── 外注費/
│   └── 02月/
│       ├── 経費申請/
│       ├── 請求書払い/
│       └── 外注費/
└── 2025/
    └── ...
```

## 4. 環境変数の設定

### 4.1 .envファイルの設定
`.env`ファイルに以下の変数を追加：

```env
# Google Cloud Service Account認証情報
GOOGLE_PROJECT_ID=your_project_id
GOOGLE_PRIVATE_KEY_ID=your_private_key_id
GOOGLE_PRIVATE_KEY="your_private_key"
GOOGLE_CLIENT_EMAIL=your_service_account_email@your_project.iam.gserviceaccount.com
GOOGLE_CLIENT_ID=your_client_id
GOOGLE_CLIENT_CERT_URL=https://www.googleapis.com/robot/v1/metadata/x509/your_service_account_email%40your_project.iam.gserviceaccount.com

# スプレッドシートID（全支出データ統合用）
GOOGLE_SHEETS_ALL_EXPENSES_ID=your_all_expenses_spreadsheet_id

# Google Drive設定（画像ファイル整理用）
GOOGLE_DRIVE_ROOT_FOLDER_ID=your_drive_root_folder_id
```

### 4.2 認証情報の注意点
- `GOOGLE_PRIVATE_KEY`は改行文字を含むため、ダブルクォートで囲む
- プライベートキーの`\\n`は実際の改行として解釈される

## 5. システムの初期化

### 5.1 Google Drive連携のセットアップ
まず、Google Drive APIとフォルダ構造を初期化：

```bash
node setup-drive.js
```

このスクリプトは：
- Google Drive APIの接続確認
- ルートフォルダの作成（自動）
- 月別・タイプ別フォルダ構造のテスト作成
- 環境変数 `GOOGLE_DRIVE_ROOT_FOLDER_ID` の取得

### 5.2 Google Sheets連携のセットアップ
次に、Google Sheetsのヘッダー行を設定：

```bash
node src/scripts/setup-sheets.js
```

このスクリプトは：
- 全支出データシートに統合フォーマットのヘッダー行を設定
- マネーフォワード連携に最適化されたデータ構造を構築

### 5.3 統合システムのヘッダー構成
**全支出データシート（A列〜Q列、17列）：**
- ID, 支出タイプ, 申請日, 支払日, 申請者, 部署, 金額, 勘定科目, 説明, 支払方法, 支払先, プロジェクト, イベント, 承認日, 承認者, ステータス, 備考

**支出タイプの種類：**
- `経費申請`: 承認された経費申請
- `請求書払い`: 承認された請求書払い申請
- `外注費`: 完了または支払い待ち状態の外注契約

## 6. 動作確認

### 6.1 統合システムのテスト
**データ同期テスト:**
1. **経費申請**: 申請管理画面で承認待ちの経費申請を承認
2. **請求書払い申請**: 申請管理画面で承認待ちの請求書払い申請を承認
3. **外注契約**: 外注管理画面で契約のステータスを「完了」または「支払い待ち」に変更

**確認項目:**
- Google Sheetsの「全支出データ」シートに各データが自動的に追加
- Google Driveの該当フォルダに領収書・請求書画像が月別に整理
- ファイル名が `[申請ID]_[申請者]_[日付]_[説明]` 形式で自動命名

### 6.2 エラーの確認
承認処理時にGoogle Sheets同期でエラーが発生しても、承認処理自体は継続されます。エラーはサーバーログに記録されます。

## 7. トラブルシューティング

### よくある問題と解決方法

**1. 認証エラー**
```
Google Sheets認証エラー: Error: invalid_grant
```
- プライベートキーの形式を確認
- サービスアカウントが有効か確認
- システム時刻が正確か確認

**2. 権限エラー**
```
The caller does not have permission
```
- スプレッドシートにサービスアカウントが編集者として追加されているか確認
- Google Sheets APIが有効化されているか確認

**3. スプレッドシートが見つからない**
```
Requested entity was not found
```
- スプレッドシートIDが正しいか確認
- スプレッドシートが削除されていないか確認

**4. シート名エラー**
```
Unable to parse range: 承認済み経費申請
```
- スプレッドシート内のシート名が正しいか確認
- シート名に特殊文字が含まれていないか確認

**5. Google Drive APIエラー**
```
The API returned an error: Error: insufficient permissions
```
- Google Drive APIが有効化されているか確認
- サービスアカウントがDriveへの書き込み権限を持っているか確認

**6. サービスアカウント容量エラー**
```
Service Accounts do not have storage quota. Leverage shared drives
```
- **解決方法**: 共有ドライブ（Team Drive）を作成する必要があります
- 個人ドライブではなく共有ドライブを使用してください
- 上記「3.1 共有ドライブの作成」の手順に従ってください

**7. フォルダ作成エラー**
```
Error: Parent not found
```
- `GOOGLE_DRIVE_ROOT_FOLDER_ID`が正しいか確認
- ルートフォルダがサービスアカウントと共有されているか確認
- 共有ドライブのIDが正しく設定されているか確認

## 8. セキュリティ考慮事項

- サービスアカウントのJSONファイルは安全に保管
- 環境変数は本番環境では適切に管理
- スプレッドシート・Driveフォルダの共有は最小権限の原則に従う
- 定期的にアクセスログを確認
- 画像ファイルには機密情報が含まれる可能性があるため適切な管理が必要

## 9. マネーフォワード連携

### 9.1 データフォーマット
統合されたGoogle Sheetsのデータは、マネーフォワードとの連携に最適化されています：

**マネーフォワード取り込み用の主要項目：**
- **支払日**: マネーフォワードの取引日として使用
- **金額**: 支出金額
- **勘定科目**: 仕訳の勘定科目
- **支払先**: 取引先情報
- **説明**: 摘要として使用
- **部署**: 部門別集計用
- **支出タイプ**: 経費分類用

### 9.2 マネーフォワードへの取り込み手順
1. Google Sheetsから対象期間のデータをCSVエクスポート
2. 必要に応じてマネーフォワードの取り込み形式に調整
3. マネーフォワードの仕訳インポート機能を使用して取り込み

### 9.3 連携のメリット
- **データ統合**: 全ての支出データが一元管理される
- **重複排除**: IDベースで重複データを防止
- **追跡可能性**: 各支出の承認フローが記録される
- **自動化**: 手動入力作業の大幅削減
- **証憑管理**: Google Driveで領収書・請求書が自動整理され、証憑確認が容易

## 10. メンテナンス

### 定期的な確認事項
- サービスアカウントキーの有効期限
- スプレッドシート・Driveフォルダのアクセス権限
- Google Sheets API・Drive APIの使用量とクォータ
- エラーログの監視
- 同期データの整合性確認
- Google Drive容量の監視

### データのバックアップ
- Google Sheetsのデータは定期的にバックアップすることを推奨
- Google Driveの画像ファイルも定期的なバックアップが必要
- 特にマネーフォワード取り込み前は必ずバックアップを取得
- 重要な契約書・領収書画像は複数箇所での保管を検討