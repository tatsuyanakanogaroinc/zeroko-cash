# データエクスポート機能修正 - テスト手順

## 修正した問題

### 1. 統合データ（承認済み）の問題
**修正前の問題**:
- ❌ 承認日・承認者が入っていない  
- ❌ 支払日が入ってしまっている（まだ精算していない）
- ❌ 外注契約が含まれていない

**修正後**:
- ✅ 承認日・承認者を正しく表示（`approved_at`、`approved_by_user`）
- ✅ 支払日は承認済みでもnull（まだ精算していないため）
- ✅ 外注契約も統合データに含まれる

### 2. 経費申請のみCSVの問題
**修正前の問題**:
- ❌ 作成日時が不要なのに含まれている
- ❌ 経費日の名称が不明確

**修正後**:
- ✅ 作成日時列を削除
- ✅ 「経費日」を「精算日」に変更
- ✅ 申請日は`created_at`を使用

### 3. 請求書払いCSVの問題
**修正前の問題**:
- ❌ 申請日=請求日になっている
- ❌ 作成日時が不要なのに含まれている

**修正後**:
- ✅ 申請日は`created_at`を使用
- ✅ 作成日時列を削除
- ✅ 請求書日は`invoice_date`のまま

### 4. 画像一括ダウンロードの改善
**追加された機能**:
- ✅ 詳細なログ出力でデバッグ可能
- ✅ タイムアウト設定（30秒）
- ✅ エラーハンドリングの強化
- ✅ ダウンロード進捗の表示

## テスト手順

### 1. 統合データCSVのテスト
1. http://localhost:3003/admin/approvals にアクセス
2. 「承認済み」タブに切り替え
3. 「統合データ（経費・請求書・外注契約）」をクリック
4. ダウンロードされたCSVを確認

**期待される結果**:
```csv
ID,支出タイプ,申請日,支払日,申請者,部署,金額,勘定科目,説明,支払方法,支払先,プロジェクト,イベント,承認日,承認者,ステータス,備考
exp001,経費申請,2024-01-15,,田中太郎,営業部,5000,交通費,出張費用,個人立替,,,プロジェクトA,,2024-01-16,佐藤管理者,承認済み,
inv001,請求書払い,2024-01-15,,田中太郎,営業部,10000,外注費,システム開発,銀行振込,ABC株式会社,,プロジェクトA,,2024-01-16,佐藤管理者,承認済み,
sub001,外注費,2024-01-15,,XYZ株式会社,,50000,外注費,デザイン業務,一回払い,XYZ株式会社,,プロジェクトB,,2024-01-16,佐藤管理者,完了,
```

**重要チェックポイント**:
- ✅ 外注契約データが含まれている
- ✅ 承認済みでも支払日は空白
- ✅ 承認日・承認者が正しく表示
- ✅ 申請日は作成日時（created_at）

### 2. 経費申請のみCSVのテスト  
1. 「経費申請のみ」ボタンをクリック
2. ダウンロードされたCSVを確認

**期待されるヘッダー**:
```csv
申請ID,申請日,精算日,申請者,部門,説明,金額,勘定科目,プロジェクト,イベント,支払方法,ステータス,コメント,更新日時
```

**チェックポイント**:
- ✅ 「作成日時」列がない
- ✅ 「精算日」と表記されている
- ✅ 申請日は`created_at`

### 3. 請求書払いのみCSVのテスト
1. 「請求書払いのみ」ボタンをクリック  
2. ダウンロードされたCSVを確認

**期待されるヘッダー**:
```csv
申請ID,申請日,請求書日,申請者,部門,目的,金額,勘定科目,プロジェクト,イベント,支払先,支払方法,ステータス,コメント,更新日時
```

**チェックポイント**:
- ✅ 「作成日時」列がない
- ✅ 申請日は`created_at`、請求書日は`invoice_date`
- ✅ 申請日≠請求書日

### 4. 画像一括ダウンロードのテスト
1. 「画像一括ダウンロード」セクションで「すべての画像」をクリック
2. ブラウザの開発者ツール（F12）でConsoleタブを確認

**期待されるログ**:
```
Found X expense records with images
Processing expense exp001 with image: https://...
Attempting to download: https://...
Successfully downloaded: filename.jpg (12345 bytes)
Added file to zip: exp001_田中太郎_2024-01-15_出張費用.jpg
Download summary: 5/5 files successfully processed
Generating ZIP file...
ZIP file generated: 123456 bytes
```

**チェックポイント**:
- ✅ ログが詳細に出力される
- ✅ ZIPファイルがダウンロードされる
- ✅ ZIPファイルに画像が含まれている
- ✅ ファイル名が適切にフォーマットされている

### 5. フィルター条件の確認
**月別フィルター**:
1. 月選択で「2024年1月」を選択
2. 各CSVをダウンロード
3. **期待**: 2024年1月の申請のみが含まれる

**ステータスフィルター**:
1. 「承認待ち」「承認済み」「却下」の各タブでテスト
2. **期待**: 選択したステータスのデータのみダウンロード

## 修正されたファイル

### src/app/api/export/csv/route.ts
- 統合データに外注契約を含める
- 承認日・承認者の正しい取得
- 支払日を承認済みでもnullに設定
- 経費申請・請求書払いの申請日修正
- 不要な「作成日時」列の削除

### src/app/api/export/images/route.ts  
- 詳細なログ出力追加
- タイムアウト設定（30秒）
- エラーハンドリング強化
- ダウンロード進捗表示

### src/app/admin/approvals/page.tsx
- 統合データの表示名を「経費・請求書・外注契約」に変更

## データベースの注意点

修正では以下のフィールドを使用しています：
- `approved_at`: 承認日時
- `approved_by`: 承認者ID  
- `approved_by_user`: 承認者のユーザー情報

これらのフィールドがデータベースに存在し、承認処理時に正しく設定されていることを確認してください。

## トラブルシューティング

### 画像ダウンロードが失敗する場合
1. ブラウザのコンソールでログを確認
2. Supabase Storageのアクセス権限を確認  
3. 画像URLが有効かチェック

### CSVに承認日・承認者が表示されない場合
1. データベースのapproval関連フィールドを確認
2. 承認処理APIでこれらのフィールドが更新されているか確認

この修正により、担当者から指摘されたすべての問題が解決されるはずです。